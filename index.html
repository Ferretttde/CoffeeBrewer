<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#8B5A3C">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>BrewTracker</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #D4A574 0%, #A67C52 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #F5EDE0;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(62, 39, 35, 0.4);
            overflow: hidden;
        }

        header {
            background: linear-gradient(rgba(62, 39, 35, 0.85), rgba(62, 39, 35, 0.85));
            color: #F5EDE0;
            padding: 40px 30px;
            text-align: center;
            border-bottom: 4px solid #6B4423;
            position: relative;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0,0,0,0.03) 2px,
                rgba(0,0,0,0.03) 4px
            );
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            position: relative;
            z-index: 1;
        }

        .subtitle {
            opacity: 0.95;
            font-size: 1.1em;
            font-style: italic;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 20px;
        }

        /* View Switching */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #3E2723;
            display: flex;
            justify-content: center;
            gap: 0;
            padding: 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .nav-tab {
            flex: 1;
            max-width: 200px;
            padding: 15px 20px;
            border: none;
            background: transparent;
            color: #A67C52;
            font-size: 1em;
            font-family: 'Georgia', serif;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-tab.active {
            color: #F5EDE0;
            background: rgba(255,255,255,0.1);
        }

        .nav-tab svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            font-family: 'Georgia', serif;
        }

        .btn-primary {
            background: #8B5A3C;
            color: #F5EDE0;
        }

        .btn-primary:hover {
            background: #6B4423;
        }

        .btn-secondary {
            background: #A67C52;
            color: #F5EDE0;
        }

        .btn-secondary:hover {
            background: #8B5A3C;
        }

        .btn-danger {
            background: #A0522D;
            color: #F5EDE0;
        }

        .btn-danger:hover {
            background: #8B4513;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.9em;
        }

        .toggle-form-btn {
            background: linear-gradient(135deg, #8B5A3C 0%, #6B4423 100%);
            color: #F5EDE0;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(107, 68, 35, 0.3);
        }

        .toggle-form-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(107, 68, 35, 0.4);
            background: linear-gradient(135deg, #6B4423 0%, #5A3A1F 100%);
        }

        /* Form Styles */
        .form-container {
            background: #FDFAF5;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            display: none;
            border: 2px solid #D4A574;
            box-shadow: inset 0 2px 4px rgba(107, 68, 35, 0.1);
        }

        .form-container.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #3E2723;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #D4A574;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s;
            background: #FFF;
            font-family: 'Georgia', serif;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #8B5A3C;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .brew-sequence {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid #E8D5B7;
        }

        .brew-sequence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .brew-sequence-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .rating {
            display: flex;
            gap: 10px;
            flex-direction: row-reverse;
            justify-content: flex-end;
        }

        .rating input[type="radio"] {
            display: none;
        }

        .rating label {
            font-size: 2em;
            cursor: pointer;
            color: #E8D5B7;
            transition: color 0.2s;
        }

        .rating input[type="radio"]:checked ~ label,
        .rating label:hover,
        .rating label:hover ~ label {
            color: #D4A574;
        }

        /* Entries List */
        .entries-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .entries-header h2 {
            color: #3E2723;
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .entries-list {
            display: grid;
            gap: 15px;
        }

        .entry-card {
            background: #FDFAF5;
            border: 2px solid #D4A574;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .entry-card:hover {
            border-color: #8B5A3C;
            box-shadow: 0 5px 15px rgba(107, 68, 35, 0.2);
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .entry-header:hover .entry-title {
            color: #8B5A3C;
        }

        .entry-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #3E2723;
            transition: color 0.3s;
        }

        .entry-date {
            color: #8B6F47;
            font-size: 0.9em;
            font-style: italic;
        }

        .entry-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .entry-content.expanded {
            max-height: 2000px;
        }

        .entry-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .entry-detail {
            font-size: 0.95em;
            color: #3E2723;
        }

        .entry-detail strong {
            color: #6B4423;
        }

        .entry-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .stars {
            color: #D4A574;
            font-size: 1.2em;
        }

        .brew-sequences-display {
            margin: 15px 0;
            padding: 15px;
            background: #F5EDE0;
            border-radius: 8px;
            border-left: 4px solid #8B5A3C;
        }

        .brew-sequences-display strong {
            display: block;
            margin-bottom: 10px;
            color: #3E2723;
            font-size: 1em;
        }

        .sequences-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sequence-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background: #FDFAF5;
            border-radius: 5px;
            font-size: 0.95em;
            border: 1px solid #E8D5B7;
        }

        .sequence-number {
            font-weight: 700;
            color: #8B5A3C;
            min-width: 20px;
        }

        .sequence-detail {
            color: #5A3A1F;
        }

        .sequence-detail:not(:last-child)::after {
            content: '→';
            margin-left: 8px;
            color: #A67C52;
        }

        /* Dashboard Styles */
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .period-selector {
            display: flex;
            gap: 10px;
        }

        .period-selector .btn {
            padding: 12px 25px;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(107, 68, 35, 0.3);
        }

        .period-selector .btn.active {
            background: #6B4423;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn-arrow {
            padding: 12px 20px;
            font-size: 18px;
        }

        .period-info {
            background: #FDFAF5;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            color: #3E2723;
            border: 2px solid #D4A574;
            min-width: 250px;
            text-align: center;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: #FDFAF5;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(107, 68, 35, 0.2);
            border: 2px solid #D4A574;
        }

        .chart-title {
            font-size: 1.3em;
            color: #3E2723;
            margin-bottom: 15px;
            font-weight: 700;
            border-bottom: 2px solid #E8D5B7;
            padding-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #6B4423;
        }

        .error-message {
            background: #A0522D;
            color: #F5EDE0;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
        }

        /* Export/Import Buttons */
        .data-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .data-actions .btn {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-input {
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                padding-bottom: 70px;
            }

            .brew-sequence-inputs {
                grid-template-columns: 1fr;
            }

            .entry-details {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }

            .controls {
                flex-direction: column;
            }

            .period-info {
                min-width: auto;
                width: 100%;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .entries-header {
                flex-direction: column;
                align-items: stretch;
            }

            .sort-controls {
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="headerTitle">BrewTracker</h1>
            <p class="subtitle" id="headerSubtitle">Dokumentiere deine perfekte Tasse Kaffee</p>
        </header>

        <div class="content">
            <!-- Logger View -->
            <div class="view active" id="loggerView">
                <div class="data-actions">
                    <button class="btn btn-secondary" onclick="exportData()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                        Export
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/></svg>
                        Import
                    </button>
                    <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
                </div>

                <button class="toggle-form-btn" onclick="toggleForm()">+ Neuer Braueintrag</button>

                <div class="form-container" id="formContainer">
                    <form id="brewForm" onsubmit="saveBrew(event)">
                        <input type="hidden" id="editId">

                        <div class="form-group">
                            <label>Kaffee Name:</label>
                            <input type="text" id="coffeeName" list="coffeeNamesList" required>
                            <datalist id="coffeeNamesList"></datalist>
                        </div>

                        <div class="form-group">
                            <label>Mahlgrad:</label>
                            <input type="number" id="grindSize" step="0.1" required>
                        </div>

                        <div class="form-group">
                            <label>Kaffeemenge (g):</label>
                            <input type="number" id="coffeeAmount" step="0.1" required>
                        </div>

                        <div class="form-group">
                            <label>Wassermenge (ml):</label>
                            <input type="number" id="waterAmount" required>
                        </div>

                        <div class="form-group">
                            <label>Wassertemperatur (°C):</label>
                            <input type="number" id="waterTemp" required>
                        </div>

                        <div class="form-group">
                            <label>Brühsequenzen:</label>
                            <div id="brewSequences"></div>
                            <button type="button" class="btn btn-secondary btn-small" onclick="addBrewSequence()">+ Sequenz hinzufügen</button>
                        </div>

                        <div class="form-group">
                            <label>Durchlaufzeit (mm:ss):</label>
                            <input type="text" id="brewTime" placeholder="03:30" pattern="[0-9]{1,2}:[0-9]{2}" required>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="frenchPress" style="width: auto; margin-right: 10px; cursor: pointer;">
                                French Press Zubereitung
                            </label>
                        </div>

                        <div class="form-group">
                            <label>Geschmack:</label>
                            <div class="rating">
                                <input type="radio" name="taste" id="taste5" value="5" required>
                                <label for="taste5">★</label>
                                <input type="radio" name="taste" id="taste4" value="4">
                                <label for="taste4">★</label>
                                <input type="radio" name="taste" id="taste3" value="3">
                                <label for="taste3">★</label>
                                <input type="radio" name="taste" id="taste2" value="2">
                                <label for="taste2">★</label>
                                <input type="radio" name="taste" id="taste1" value="1">
                                <label for="taste1">★</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Notizen:</label>
                            <textarea id="notes"></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Speichern</button>
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Abbrechen</button>
                        </div>
                    </form>
                </div>

                <div class="entries-header">
                    <h2>Meine Braueinträge</h2>
                    <div class="sort-controls">
                        <label>Sortieren nach:</label>
                        <select id="sortBy" onchange="loadEntries()">
                            <option value="created_at">Datum</option>
                            <option value="coffee_name">Kaffee Name</option>
                            <option value="taste">Geschmack</option>
                            <option value="grind_size">Mahlgrad</option>
                            <option value="water_amount">Wassermenge</option>
                        </select>
                    </div>
                </div>

                <div class="entries-list" id="entriesList"></div>
            </div>

            <!-- Dashboard View -->
            <div class="view" id="dashboardView">
                <div class="controls">
                    <button class="btn btn-arrow" onclick="navigatePeriod(-1)">←</button>

                    <div class="period-selector">
                        <button class="btn active" id="btnWeek" onclick="changePeriodType('week')">Woche</button>
                        <button class="btn" id="btnMonth" onclick="changePeriodType('month')">Monat</button>
                        <button class="btn" id="btnYear" onclick="changePeriodType('year')">Jahr</button>
                    </div>

                    <button class="btn btn-arrow" onclick="navigatePeriod(1)">→</button>
                </div>

                <div class="period-info" id="periodInfo"></div>

                <div id="loading" class="loading" style="display: none;">Lade Daten...</div>
                <div id="dashboardError" class="error-message" style="display: none;"></div>

                <div id="charts">
                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-title">Einträge pro Tag</div>
                            <canvas id="entriesChart"></canvas>
                        </div>

                        <div class="chart-container">
                            <div class="chart-title">Wassermenge pro Tag (ml)</div>
                            <canvas id="waterChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Kaffeemenge pro Kaffeesorte (g)</div>
                        <canvas id="coffeeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-tab active" onclick="switchView('logger')">
            <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
            Logger
        </button>
        <button class="nav-tab" onclick="switchView('dashboard')">
            <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
            Dashboard
        </button>
    </nav>

    <script>
        // ============================================
        // IndexedDB Storage Layer
        // ============================================
        class BrewDB {
            constructor() {
                this.dbName = 'BrewTrackerDB';
                this.dbVersion = 1;
                this.storeName = 'brews';
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;

                        if (!db.objectStoreNames.contains(this.storeName)) {
                            const store = db.createObjectStore(this.storeName, {
                                keyPath: 'id',
                                autoIncrement: true
                            });
                            store.createIndex('created_at', 'created_at', { unique: false });
                            store.createIndex('coffee_name', 'coffee_name', { unique: false });
                            store.createIndex('taste', 'taste', { unique: false });
                            store.createIndex('grind_size', 'grind_size', { unique: false });
                            store.createIndex('water_amount', 'water_amount', { unique: false });
                        }
                    };
                });
            }

            async addBrew(brew) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);

                    brew.created_at = brew.created_at || new Date().toISOString();
                    const request = store.add(brew);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async updateBrew(id, brew) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);

                    brew.id = id;
                    const request = store.put(brew);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async deleteBrew(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.delete(id);

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async getBrew(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(id);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAllBrews(sortBy = 'created_at', ascending = false) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAll();

                    request.onsuccess = () => {
                        let results = request.result;
                        results.sort((a, b) => {
                            let valA = a[sortBy];
                            let valB = b[sortBy];

                            if (typeof valA === 'string') {
                                valA = valA.toLowerCase();
                                valB = valB.toLowerCase();
                            }

                            if (ascending) {
                                return valA < valB ? -1 : valA > valB ? 1 : 0;
                            } else {
                                return valA > valB ? -1 : valA < valB ? 1 : 0;
                            }
                        });
                        resolve(results);
                    };
                    request.onerror = () => reject(request.error);
                });
            }

            async getBrewsInRange(startDate, endDate) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const index = store.index('created_at');
                    const range = IDBKeyRange.bound(startDate.toISOString(), endDate.toISOString());
                    const request = index.getAll(range);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getUniqueCoffeeNames() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAll();

                    request.onsuccess = () => {
                        const names = [...new Set(request.result.map(item => item.coffee_name))];
                        resolve(names.filter(n => n));
                    };
                    request.onerror = () => reject(request.error);
                });
            }

            async exportAll() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async importBrews(brews, replace = false) {
                return new Promise(async (resolve, reject) => {
                    try {
                        if (replace) {
                            const transaction = this.db.transaction([this.storeName], 'readwrite');
                            const store = transaction.objectStore(this.storeName);
                            await new Promise((res, rej) => {
                                const clearReq = store.clear();
                                clearReq.onsuccess = () => res();
                                clearReq.onerror = () => rej(clearReq.error);
                            });
                        }

                        for (const brew of brews) {
                            const brewCopy = { ...brew };
                            delete brewCopy.id; // Let auto-increment handle IDs
                            await this.addBrew(brewCopy);
                        }
                        resolve(brews.length);
                    } catch (error) {
                        reject(error);
                    }
                });
            }
        }

        // ============================================
        // Global State
        // ============================================
        const brewDB = new BrewDB();
        let entriesChart, waterChart, coffeeChart;
        let currentPeriodType = 'week';
        let currentOffset = 0;
        let currentView = 'logger';

        // ============================================
        // View Switching
        // ============================================
        function switchView(view) {
            currentView = view;

            // Update views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(view + 'View').classList.add('active');

            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.nav-tab[onclick="switchView('${view}')"]`).classList.add('active');

            // Update header
            if (view === 'logger') {
                document.getElementById('headerTitle').textContent = 'BrewTracker';
                document.getElementById('headerSubtitle').textContent = 'Dokumentiere deine perfekte Tasse Kaffee';
            } else {
                document.getElementById('headerTitle').textContent = 'Dashboard';
                document.getElementById('headerSubtitle').textContent = 'Alles was ich wissen muss.';
                loadDashboardData();
            }
        }

        // ============================================
        // Logger Functions
        // ============================================
        function toggleForm() {
            const form = document.getElementById('formContainer');
            form.classList.toggle('active');
        }

        function addBrewSequence() {
            const container = document.getElementById('brewSequences');
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'brew-sequence';
            div.innerHTML = `
                <div class="brew-sequence-header">
                    <strong>Sequenz ${index + 1}</strong>
                    <button type="button" class="btn btn-danger btn-small" onclick="removeBrewSequence(this)">Entfernen</button>
                </div>
                <div class="brew-sequence-inputs">
                    <div>
                        <label>Wassermenge (g):</label>
                        <input type="number" class="seq-water" step="0.1" required>
                    </div>
                    <div>
                        <label>Wartezeit (s):</label>
                        <input type="number" class="seq-wait" required>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function removeBrewSequence(btn) {
            btn.closest('.brew-sequence').remove();
            updateSequenceNumbers();
        }

        function updateSequenceNumbers() {
            const sequences = document.querySelectorAll('.brew-sequence');
            sequences.forEach((seq, index) => {
                seq.querySelector('strong').textContent = `Sequenz ${index + 1}`;
            });
        }

        async function saveBrew(event) {
            event.preventDefault();

            const sequences = [];
            document.querySelectorAll('.brew-sequence').forEach(seq => {
                sequences.push({
                    water: parseFloat(seq.querySelector('.seq-water').value),
                    wait: parseInt(seq.querySelector('.seq-wait').value)
                });
            });

            const tasteRadio = document.querySelector('input[name="taste"]:checked');
            if (!tasteRadio) {
                alert('Bitte wähle eine Geschmacksbewertung aus.');
                return;
            }

            const data = {
                coffee_name: document.getElementById('coffeeName').value,
                grind_size: parseFloat(document.getElementById('grindSize').value),
                coffee_amount: parseFloat(document.getElementById('coffeeAmount').value),
                water_amount: parseInt(document.getElementById('waterAmount').value),
                water_temp: parseInt(document.getElementById('waterTemp').value),
                brew_sequences: sequences,
                brew_time: document.getElementById('brewTime').value,
                is_french_press: document.getElementById('frenchPress').checked,
                taste: parseInt(tasteRadio.value),
                notes: document.getElementById('notes').value
            };

            const editId = document.getElementById('editId').value;

            try {
                if (editId) {
                    const existingBrew = await brewDB.getBrew(parseInt(editId));
                    data.created_at = existingBrew.created_at;
                    await brewDB.updateBrew(parseInt(editId), data);
                } else {
                    await brewDB.addBrew(data);
                }

                document.getElementById('brewForm').reset();
                document.getElementById('editId').value = '';
                document.getElementById('brewSequences').innerHTML = '';
                toggleForm();
                loadEntries();
                loadCoffeeNames();
            } catch (error) {
                alert('Fehler beim Speichern: ' + error.message);
            }
        }

        async function loadEntries() {
            const sortBy = document.getElementById('sortBy').value;
            const ascending = sortBy !== 'created_at' && sortBy !== 'taste';

            try {
                const data = await brewDB.getAllBrews(sortBy, ascending);
                displayEntries(data);
            } catch (error) {
                console.error('Fehler beim Laden:', error);
            }
        }

        function displayEntries(entries) {
            const container = document.getElementById('entriesList');
            container.innerHTML = '';

            if (entries.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6B4423; padding: 30px;">Noch keine Einträge vorhanden.</p>';
                return;
            }

            entries.forEach(entry => {
                const card = document.createElement('div');
                card.className = 'entry-card';
                const stars = '★'.repeat(entry.taste) + '☆'.repeat(5 - entry.taste);
                const date = new Date(entry.created_at).toLocaleDateString('de-DE');

                const sequencesHTML = (entry.brew_sequences || []).map((seq, index) => `
                    <div class="sequence-item">
                        <span class="sequence-number">${index + 1}.</span>
                        <span class="sequence-detail">${seq.water}g Wasser</span>
                        <span class="sequence-detail">${seq.wait}s warten</span>
                    </div>
                `).join('');

                card.innerHTML = `
                    <div class="entry-header" onclick="toggleEntry(this)">
                        <div>
                            <div class="entry-title">${entry.coffee_name}</div>
                            <div class="entry-date">${date}</div>
                        </div>
                        <div class="stars">${stars}</div>
                        <div class="stars">${entry.water_amount}ml</div>
                    </div>
                    <div class="entry-content">
                        <div class="entry-details">
                            <div class="entry-detail"><strong>Mahlgrad:</strong> ${entry.grind_size}</div>
                            <div class="entry-detail"><strong>Kaffee:</strong> ${entry.coffee_amount}g</div>
                            <div class="entry-detail"><strong>Wasser:</strong> ${entry.water_amount}ml</div>
                            <div class="entry-detail"><strong>Temperatur:</strong> ${entry.water_temp}°C</div>
                            <div class="entry-detail"><strong>Zeit:</strong> ${entry.brew_time}</div>
                            <div class="entry-detail"><strong>Methode:</strong> ${entry.is_french_press ? 'French Press' : 'Pour Over'}</div>
                        </div>
                        ${sequencesHTML ? `
                        <div class="brew-sequences-display">
                            <strong>Brühsequenzen:</strong>
                            <div class="sequences-list">${sequencesHTML}</div>
                        </div>
                        ` : ''}
                        ${entry.notes ? `<p><strong>Notizen:</strong> ${entry.notes}</p>` : ''}
                        <div class="entry-actions">
                            <button class="btn btn-primary btn-small" onclick="event.stopPropagation(); editEntry(${entry.id})">Bearbeiten</button>
                            <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); deleteEntry(${entry.id})">Löschen</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function loadCoffeeNames() {
            try {
                const names = await brewDB.getUniqueCoffeeNames();
                const datalist = document.getElementById('coffeeNamesList');
                datalist.innerHTML = names.map(name => `<option value="${name}">`).join('');
            } catch (error) {
                console.error('Fehler beim Laden der Kaffeenamen:', error);
            }
        }

        async function editEntry(id) {
            try {
                const data = await brewDB.getBrew(id);

                document.getElementById('editId').value = data.id;
                document.getElementById('coffeeName').value = data.coffee_name;
                document.getElementById('grindSize').value = data.grind_size;
                document.getElementById('coffeeAmount').value = data.coffee_amount;
                document.getElementById('waterAmount').value = data.water_amount;
                document.getElementById('waterTemp').value = data.water_temp;
                document.getElementById('brewTime').value = data.brew_time;
                document.getElementById('frenchPress').checked = data.is_french_press || false;
                document.getElementById(`taste${data.taste}`).checked = true;
                document.getElementById('notes').value = data.notes || '';

                document.getElementById('brewSequences').innerHTML = '';
                (data.brew_sequences || []).forEach(seq => {
                    addBrewSequence();
                    const lastSeq = document.querySelector('.brew-sequence:last-child');
                    lastSeq.querySelector('.seq-water').value = seq.water;
                    lastSeq.querySelector('.seq-wait').value = seq.wait;
                });

                document.getElementById('formContainer').classList.add('active');
                document.getElementById('formContainer').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                alert('Fehler beim Laden des Eintrags: ' + error.message);
            }
        }

        async function deleteEntry(id) {
            if (!confirm('Möchtest du diesen Eintrag wirklich löschen?')) return;
            try {
                await brewDB.deleteBrew(id);
                loadEntries();
            } catch (error) {
                alert('Fehler beim Löschen: ' + error.message);
            }
        }

        function toggleEntry(header) {
            const content = header.nextElementSibling;
            content.classList.toggle('expanded');
        }

        function cancelEdit() {
            document.getElementById('brewForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('brewSequences').innerHTML = '';
            toggleForm();
        }

        // ============================================
        // Export/Import Functions
        // ============================================
        async function exportData() {
            try {
                const data = await brewDB.exportAll();
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const date = new Date().toISOString().split('T')[0];
                const a = document.createElement('a');
                a.href = url;
                a.download = `brewtracker-backup-${date}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('Fehler beim Export: ' + error.message);
            }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                if (!Array.isArray(data)) {
                    throw new Error('Ungültiges Datenformat. Erwartet: Array von Braueinträgen.');
                }

                // Validate data structure
                const requiredFields = ['coffee_name', 'grind_size', 'coffee_amount', 'water_amount', 'water_temp', 'brew_time', 'taste'];
                for (const brew of data) {
                    for (const field of requiredFields) {
                        if (brew[field] === undefined) {
                            throw new Error(`Fehlende Pflichtfeld: ${field}`);
                        }
                    }
                }

                const replace = confirm('Möchtest du alle bestehenden Daten ersetzen?\n\nOK = Ersetzen\nAbbrechen = Hinzufügen');
                const count = await brewDB.importBrews(data, replace);
                alert(`${count} Einträge erfolgreich importiert!`);
                loadEntries();
                loadCoffeeNames();
            } catch (error) {
                alert('Fehler beim Import: ' + error.message);
            }

            event.target.value = '';
        }

        // ============================================
        // Dashboard Functions
        // ============================================
        function getDateRange(periodType, offset) {
            const now = new Date();
            let start = new Date();
            let end = new Date();

            if (periodType === 'week') {
                const day = now.getDay();
                const diff = day === 0 ? 6 : day - 1;
                start.setDate(now.getDate() - diff - (offset * 7));
                start.setHours(0, 0, 0, 0);

                end = new Date(start);
                end.setDate(start.getDate() + 6);
                end.setHours(23, 59, 59, 999);
            } else if (periodType === 'month') {
                start = new Date(now.getFullYear(), now.getMonth() - offset, 1);
                start.setHours(0, 0, 0, 0);

                end = new Date(start.getFullYear(), start.getMonth() + 1, 0);
                end.setHours(23, 59, 59, 999);
            } else if (periodType === 'year') {
                start = new Date(now.getFullYear() - offset, 0, 1);
                start.setHours(0, 0, 0, 0);

                end = new Date(start.getFullYear(), 11, 31);
                end.setHours(23, 59, 59, 999);
            }

            return { start, end };
        }

        function formatPeriodInfo(periodType, offset) {
            const { start, end } = getDateRange(periodType, offset);

            const formatDate = (date) => {
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                return `${day}.${month}.${year}`;
            };

            if (periodType === 'week') {
                return `Woche: ${formatDate(start)} - ${formatDate(end)}`;
            } else if (periodType === 'month') {
                const monthNames = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni',
                                   'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                return `${monthNames[start.getMonth()]} ${start.getFullYear()}`;
            } else if (periodType === 'year') {
                return `Jahr ${start.getFullYear()}`;
            }
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = day === 0 ? -6 : 1 - day;
            d.setDate(d.getDate() + diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function changePeriodType(periodType) {
            currentPeriodType = periodType;
            currentOffset = 0;

            document.querySelectorAll('.period-selector .btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn' + periodType.charAt(0).toUpperCase() + periodType.slice(1)).classList.add('active');

            loadDashboardData();
        }

        function navigatePeriod(direction) {
            currentOffset -= direction;
            loadDashboardData();
        }

        async function loadDashboardData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('charts').style.display = 'none';
            document.getElementById('dashboardError').style.display = 'none';

            const periodInfo = formatPeriodInfo(currentPeriodType, currentOffset);
            document.getElementById('periodInfo').textContent = periodInfo;

            try {
                const { start, end } = getDateRange(currentPeriodType, currentOffset);
                const data = await brewDB.getBrewsInRange(start, end);

                if (!data || data.length === 0) {
                    document.getElementById('dashboardError').textContent = 'Keine Daten für diesen Zeitraum gefunden.';
                    document.getElementById('dashboardError').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                    return;
                }

                processData(data);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('charts').style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('dashboardError').textContent = 'Fehler beim Laden der Daten: ' + error.message;
                document.getElementById('dashboardError').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }

        function processData(data) {
            if (currentPeriodType === 'week') {
                processWeekData(data);
            } else if (currentPeriodType === 'month') {
                processMonthData(data);
            } else if (currentPeriodType === 'year') {
                processYearData(data);
            }
        }

        function processWeekData(data) {
            const entriesByDate = {};
            const waterByDate = {};
            const coffeeByName = {};

            data.forEach(item => {
                const date = item.created_at.split('T')[0];

                entriesByDate[date] = (entriesByDate[date] || 0) + 1;
                waterByDate[date] = (waterByDate[date] || 0) + (item.water_amount || 0);

                if (item.coffee_name) {
                    coffeeByName[item.coffee_name] = (coffeeByName[item.coffee_name] || 0) + (item.coffee_amount || 0);
                }
            });

            const dates = Object.keys(entriesByDate).sort();
            const dateLabels = dates.map(d => {
                const date = new Date(d);
                return `${date.getDate().toString().padStart(2, '0')}.${(date.getMonth() + 1).toString().padStart(2, '0')}`;
            });
            const entriesData = dates.map(date => entriesByDate[date]);
            const waterData = dates.map(date => waterByDate[date]);

            const coffeeNames = Object.keys(coffeeByName).sort();
            const coffeeData = coffeeNames.map(name => coffeeByName[name]);

            updateCharts(dateLabels, entriesData, waterData, coffeeNames, coffeeData);
        }

        function processMonthData(data) {
            const entriesByWeek = {};
            const waterByWeek = {};
            const coffeeByName = {};
            const weekCounts = {};

            data.forEach(item => {
                const date = new Date(item.created_at);
                const monday = getMonday(date);
                const weekKey = monday.toISOString().split('T')[0];

                entriesByWeek[weekKey] = (entriesByWeek[weekKey] || 0) + 1;
                waterByWeek[weekKey] = (waterByWeek[weekKey] || 0) + (item.water_amount || 0);
                weekCounts[weekKey] = (weekCounts[weekKey] || new Set()).add(date.toISOString().split('T')[0]);

                if (item.coffee_name) {
                    coffeeByName[item.coffee_name] = (coffeeByName[item.coffee_name] || 0) + (item.coffee_amount || 0);
                }
            });

            const weeks = Object.keys(entriesByWeek).sort();
            const weekLabels = weeks.map(w => {
                const date = new Date(w);
                return `KW ${getWeekNumber(date)}`;
            });

            const entriesData = weeks.map(week => {
                const daysInWeek = weekCounts[week].size;
                return Math.round((entriesByWeek[week] / daysInWeek) * 10) / 10;
            });

            const waterData = weeks.map(week => {
                const daysInWeek = weekCounts[week].size;
                return Math.round((waterByWeek[week] / daysInWeek) * 10) / 10;
            });

            const coffeeNames = Object.keys(coffeeByName).sort();
            const coffeeData = coffeeNames.map(name => coffeeByName[name]);

            updateCharts(weekLabels, entriesData, waterData, coffeeNames, coffeeData);
        }

        function processYearData(data) {
            const entriesByMonth = {};
            const waterByMonth = {};
            const coffeeByName = {};
            const monthCounts = {};

            data.forEach(item => {
                const date = new Date(item.created_at);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;

                entriesByMonth[monthKey] = (entriesByMonth[monthKey] || 0) + 1;
                waterByMonth[monthKey] = (waterByMonth[monthKey] || 0) + (item.water_amount || 0);
                monthCounts[monthKey] = (monthCounts[monthKey] || new Set()).add(date.toISOString().split('T')[0]);

                if (item.coffee_name) {
                    coffeeByName[item.coffee_name] = (coffeeByName[item.coffee_name] || 0) + (item.coffee_amount || 0);
                }
            });

            const months = Object.keys(entriesByMonth).sort();
            const monthNames = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
            const monthLabels = months.map(m => {
                const monthNum = parseInt(m.split('-')[1]) - 1;
                return monthNames[monthNum];
            });

            const entriesData = months.map(month => {
                const daysInMonth = monthCounts[month].size;
                return Math.round((entriesByMonth[month] / daysInMonth) * 10) / 10;
            });

            const waterData = months.map(month => {
                const daysInMonth = monthCounts[month].size;
                return Math.round((waterByMonth[month] / daysInMonth) * 10) / 10;
            });

            const coffeeNames = Object.keys(coffeeByName).sort();
            const coffeeData = coffeeNames.map(name => coffeeByName[name]);

            updateCharts(monthLabels, entriesData, waterData, coffeeNames, coffeeData);
        }

        function updateCharts(dateLabels, entriesData, waterData, coffeeNames, coffeeData) {
            if (entriesChart) entriesChart.destroy();
            if (waterChart) waterChart.destroy();
            if (coffeeChart) coffeeChart.destroy();

            const color1 = 'rgba(139, 90, 60, 0.8)';
            const border1 = 'rgba(139, 90, 60, 1)';
            const color2 = 'rgba(166, 124, 82, 0.8)';
            const border2 = 'rgba(166, 124, 82, 1)';
            const color3 = 'rgba(107, 68, 35, 0.8)';
            const border3 = 'rgba(107, 68, 35, 1)';

            const labelSuffix = currentPeriodType === 'week' ? '' : ' (Ø)';

            const ctx1 = document.getElementById('entriesChart').getContext('2d');
            entriesChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: dateLabels,
                    datasets: [{
                        label: 'Anzahl Einträge' + labelSuffix,
                        data: entriesData,
                        backgroundColor: color1,
                        borderColor: border1,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: currentPeriodType === 'week' ? 1 : 0.5
                            }
                        }
                    }
                }
            });

            const ctx2 = document.getElementById('waterChart').getContext('2d');
            waterChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: dateLabels,
                    datasets: [{
                        label: 'Wassermenge (ml)' + labelSuffix,
                        data: waterData,
                        backgroundColor: color2,
                        borderColor: border2,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            const ctx3 = document.getElementById('coffeeChart').getContext('2d');
            coffeeChart = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: coffeeNames,
                    datasets: [{
                        label: 'Kaffeemenge (g)',
                        data: coffeeData,
                        backgroundColor: color3,
                        borderColor: border3,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    indexAxis: 'y'
                }
            });
        }

        // ============================================
        // Service Worker Registration
        // ============================================
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(registration => {
                    console.log('Service Worker registered:', registration.scope);
                })
                .catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
        }

        // ============================================
        // Initialization
        // ============================================
        window.onload = async function() {
            try {
                await brewDB.init();
                loadEntries();
                loadCoffeeNames();
                addBrewSequence();
            } catch (error) {
                console.error('Fehler beim Initialisieren der Datenbank:', error);
                alert('Fehler beim Initialisieren der App. Bitte Browser-Unterstützung für IndexedDB prüfen.');
            }
        };
    </script>
</body>
</html>
