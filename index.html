<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#8B5A3C">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>BrewTracker</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #D4A574 0%, #A67C52 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #F5EDE0;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(62, 39, 35, 0.4);
            overflow: hidden;
        }

        header {
            background: linear-gradient(rgba(62, 39, 35, 0.85), rgba(62, 39, 35, 0.85));
            color: #F5EDE0;
            padding: 40px 30px;
            text-align: center;
            border-bottom: 4px solid #6B4423;
            position: relative;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0,0,0,0.03) 2px,
                rgba(0,0,0,0.03) 4px
            );
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            position: relative;
            z-index: 1;
        }

        .subtitle {
            opacity: 0.95;
            font-size: 1.1em;
            font-style: italic;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 20px;
        }

        /* View Switching */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #3E2723;
            display: flex;
            justify-content: center;
            gap: 0;
            padding: 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .nav-tab {
            flex: 1;
            max-width: 200px;
            padding: 15px 20px;
            border: none;
            background: transparent;
            color: #A67C52;
            font-size: 1em;
            font-family: 'Georgia', serif;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-tab.active {
            color: #F5EDE0;
            background: rgba(255,255,255,0.1);
        }

        .nav-tab svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            font-family: 'Georgia', serif;
        }

        .btn-primary {
            background: #8B5A3C;
            color: #F5EDE0;
        }

        .btn-primary:hover {
            background: #6B4423;
        }

        .btn-secondary {
            background: #A67C52;
            color: #F5EDE0;
        }

        .btn-secondary:hover {
            background: #8B5A3C;
        }

        .btn-danger {
            background: #A0522D;
            color: #F5EDE0;
        }

        .btn-danger:hover {
            background: #8B4513;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.9em;
        }

        .toggle-form-btn {
            background: linear-gradient(135deg, #8B5A3C 0%, #6B4423 100%);
            color: #F5EDE0;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(107, 68, 35, 0.3);
        }

        .toggle-form-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(107, 68, 35, 0.4);
            background: linear-gradient(135deg, #6B4423 0%, #5A3A1F 100%);
        }

        /* Form Styles */
        .form-container {
            background: #FDFAF5;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            display: none;
            border: 2px solid #D4A574;
            box-shadow: inset 0 2px 4px rgba(107, 68, 35, 0.1);
        }

        .form-container.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #3E2723;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #D4A574;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s;
            background: #FFF;
            font-family: 'Georgia', serif;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #8B5A3C;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .brew-sequence {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid #E8D5B7;
        }

        .brew-sequence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .brew-sequence-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .rating {
            display: flex;
            gap: 10px;
            flex-direction: row-reverse;
            justify-content: flex-end;
        }

        .rating input[type="radio"] {
            display: none;
        }

        .rating label {
            font-size: 2em;
            cursor: pointer;
            color: #E8D5B7;
            transition: color 0.2s;
        }

        .rating input[type="radio"]:checked ~ label,
        .rating label:hover,
        .rating label:hover ~ label {
            color: #D4A574;
        }

        /* Entries List */
        .entries-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .entries-header h2 {
            color: #3E2723;
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .entries-list {
            display: grid;
            gap: 15px;
        }

        .entry-card {
            background: #FDFAF5;
            border: 2px solid #D4A574;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .entry-card:hover {
            border-color: #8B5A3C;
            box-shadow: 0 5px 15px rgba(107, 68, 35, 0.2);
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .entry-header:hover .entry-title {
            color: #8B5A3C;
        }

        .entry-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #3E2723;
            transition: color 0.3s;
        }

        .entry-date {
            color: #8B6F47;
            font-size: 0.9em;
            font-style: italic;
        }

        .entry-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .entry-content.expanded {
            max-height: 2000px;
        }

        .entry-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .entry-detail {
            font-size: 0.95em;
            color: #3E2723;
        }

        .entry-detail strong {
            color: #6B4423;
        }

        .entry-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .stars {
            color: #D4A574;
            font-size: 1.2em;
        }

        .brew-sequences-display {
            margin: 15px 0;
            padding: 15px;
            background: #F5EDE0;
            border-radius: 8px;
            border-left: 4px solid #8B5A3C;
        }

        .brew-sequences-display strong {
            display: block;
            margin-bottom: 10px;
            color: #3E2723;
            font-size: 1em;
        }

        .sequences-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sequence-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background: #FDFAF5;
            border-radius: 5px;
            font-size: 0.95em;
            border: 1px solid #E8D5B7;
        }

        .sequence-number {
            font-weight: 700;
            color: #8B5A3C;
            min-width: 20px;
        }

        .sequence-detail {
            color: #5A3A1F;
        }

        .sequence-detail:not(:last-child)::after {
            content: '→';
            margin-left: 8px;
            color: #A67C52;
        }

        /* Dashboard Styles */
        .variable-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            justify-content: center;
        }

        .variable-selector .btn {
            padding: 10px 16px;
            font-size: 0.95em;
            font-weight: 600;
            box-shadow: 0 3px 6px rgba(107, 68, 35, 0.25);
        }

        .variable-selector .btn.active {
            background: #6B4423;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .chart-container {
            background: #FDFAF5;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(107, 68, 35, 0.2);
            border: 2px solid #D4A574;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.3em;
            color: #3E2723;
            margin-bottom: 15px;
            font-weight: 700;
            border-bottom: 2px solid #E8D5B7;
            padding-bottom: 10px;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: #A67C52;
            color: #F5EDE0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Georgia', serif;
            font-size: 1em;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: #8B5A3C;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: #FDFAF5;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #D4A574;
            text-align: center;
        }

        .stat-card .stat-label {
            font-size: 0.85em;
            color: #8B6F47;
            margin-bottom: 5px;
        }

        .stat-card .stat-value {
            font-size: 1.4em;
            font-weight: 700;
            color: #3E2723;
        }

        .stat-card .stat-value .stars {
            font-size: 1em;
        }

        .drill-down-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .drill-down-title {
            font-size: 1.5em;
            color: #3E2723;
            font-weight: 700;
        }

        .drill-down-entries {
            margin-top: 20px;
        }

        .drill-down-entries h3 {
            color: #3E2723;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #E8D5B7;
            padding-bottom: 10px;
        }

        .common-factors {
            background: #F5EDE0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #8B5A3C;
        }

        .common-factors h4 {
            color: #3E2723;
            margin-bottom: 10px;
        }

        .common-factors ul {
            list-style: none;
            padding: 0;
        }

        .common-factors li {
            padding: 5px 0;
            color: #5A3A1F;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #6B4423;
        }

        .error-message {
            background: #A0522D;
            color: #F5EDE0;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
        }

        /* Export/Import Buttons */
        .data-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .data-actions .btn {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-input {
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                padding-bottom: 70px;
            }

            .brew-sequence-inputs {
                grid-template-columns: 1fr;
            }

            .entry-details {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }

            .variable-selector {
                gap: 8px;
            }

            .variable-selector .btn {
                padding: 8px 12px;
                font-size: 0.85em;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .entries-header {
                flex-direction: column;
                align-items: stretch;
            }

            .sort-controls {
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="headerTitle">BrewTracker</h1>
            <p class="subtitle" id="headerSubtitle">Dokumentiere deine perfekte Tasse Kaffee</p>
        </header>

        <div class="content">
            <!-- Logger View -->
            <div class="view active" id="loggerView">
                <div class="data-actions">
                    <button class="btn btn-secondary" onclick="exportData()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                        Export
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/></svg>
                        Import
                    </button>
                    <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
                </div>

                <button class="toggle-form-btn" onclick="toggleForm()">+ Neuer Braueintrag</button>

                <div class="form-container" id="formContainer">
                    <form id="brewForm" onsubmit="saveBrew(event)">
                        <input type="hidden" id="editId">

                        <div class="form-group">
                            <label>Kaffee Name:</label>
                            <input type="text" id="coffeeName" list="coffeeNamesList" required>
                            <datalist id="coffeeNamesList"></datalist>
                        </div>

                        <div class="form-group">
                            <label>Mahlgrad:</label>
                            <input type="number" id="grindSize" step="0.1" required>
                        </div>

                        <div class="form-group">
                            <label>Kaffeemenge (g):</label>
                            <input type="number" id="coffeeAmount" step="0.1" required>
                        </div>

                        <div class="form-group">
                            <label>Wassermenge (ml):</label>
                            <input type="number" id="waterAmount" required>
                        </div>

                        <div class="form-group">
                            <label>Wassertemperatur (°C):</label>
                            <input type="number" id="waterTemp" required>
                        </div>

                        <div class="form-group">
                            <label>Brühsequenzen:</label>
                            <div id="brewSequences"></div>
                            <button type="button" class="btn btn-secondary btn-small" onclick="addBrewSequence()">+ Sequenz hinzufügen</button>
                        </div>

                        <div class="form-group">
                            <label>Durchlaufzeit (mm:ss):</label>
                            <input type="text" id="brewTime" placeholder="03:30" pattern="[0-9]{1,2}:[0-9]{2}" required>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="frenchPress" style="width: auto; margin-right: 10px; cursor: pointer;">
                                French Press Zubereitung
                            </label>
                        </div>

                        <div class="form-group">
                            <label>Geschmack:</label>
                            <div class="rating">
                                <input type="radio" name="taste" id="taste5" value="5" required>
                                <label for="taste5">★</label>
                                <input type="radio" name="taste" id="taste4" value="4">
                                <label for="taste4">★</label>
                                <input type="radio" name="taste" id="taste3" value="3">
                                <label for="taste3">★</label>
                                <input type="radio" name="taste" id="taste2" value="2">
                                <label for="taste2">★</label>
                                <input type="radio" name="taste" id="taste1" value="1">
                                <label for="taste1">★</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Notizen:</label>
                            <textarea id="notes"></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Speichern</button>
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Abbrechen</button>
                        </div>
                    </form>
                </div>

                <div class="entries-header">
                    <h2>Meine Braueinträge</h2>
                    <div class="sort-controls">
                        <label>Sortieren nach:</label>
                        <select id="sortBy" onchange="loadEntries()">
                            <option value="created_at">Datum</option>
                            <option value="coffee_name">Kaffee Name</option>
                            <option value="taste">Geschmack</option>
                            <option value="grind_size">Mahlgrad</option>
                            <option value="water_amount">Wassermenge</option>
                        </select>
                    </div>
                </div>

                <div class="entries-list" id="entriesList"></div>
            </div>

            <!-- Dashboard View -->
            <div class="view" id="dashboardView">
                <div class="variable-selector" id="variableSelector">
                    <button class="btn active" data-variable="coffee_name" onclick="selectVariable('coffee_name')">Kaffee Name</button>
                    <button class="btn" data-variable="taste" onclick="selectVariable('taste')">Geschmack</button>
                    <button class="btn" data-variable="grind_size" onclick="selectVariable('grind_size')">Mahlgrad</button>
                    <button class="btn" data-variable="water_amount" onclick="selectVariable('water_amount')">Wassermenge</button>
                    <button class="btn" data-variable="coffee_amount" onclick="selectVariable('coffee_amount')">Kaffeemenge</button>
                    <button class="btn" data-variable="water_temp" onclick="selectVariable('water_temp')">Temperatur</button>
                    <button class="btn" data-variable="is_french_press" onclick="selectVariable('is_french_press')">French Press</button>
                </div>

                <div id="loading" class="loading" style="display: none;">Lade Daten...</div>
                <div id="dashboardError" class="error-message" style="display: none;"></div>

                <!-- Aggregated Bar Chart View -->
                <div id="chartView">
                    <div class="chart-container">
                        <div class="chart-title" id="chartTitle">Einträge pro Kaffee Name</div>
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <!-- Drill-Down Detail View -->
                <div id="drillDownView" style="display: none;">
                    <button class="back-btn" onclick="showChartView()">← Zurück zur Übersicht</button>

                    <div class="drill-down-header">
                        <h2 class="drill-down-title" id="drillDownTitle"></h2>
                    </div>

                    <div class="stats-grid" id="statsGrid"></div>

                    <div id="commonFactors" class="common-factors" style="display: none;"></div>

                    <div class="drill-down-entries">
                        <h3 id="entriesHeading">Einträge</h3>
                        <div class="entries-list" id="drillDownEntries"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-tab active" onclick="switchView('logger')">
            <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
            Logger
        </button>
        <button class="nav-tab" onclick="switchView('dashboard')">
            <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
            Dashboard
        </button>
    </nav>

    <script>
        // ============================================
        // IndexedDB Storage Layer
        // ============================================
        class BrewDB {
            constructor() {
                this.dbName = 'BrewTrackerDB';
                this.dbVersion = 1;
                this.storeName = 'brews';
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;

                        if (!db.objectStoreNames.contains(this.storeName)) {
                            const store = db.createObjectStore(this.storeName, {
                                keyPath: 'id',
                                autoIncrement: true
                            });
                            store.createIndex('created_at', 'created_at', { unique: false });
                            store.createIndex('coffee_name', 'coffee_name', { unique: false });
                            store.createIndex('taste', 'taste', { unique: false });
                            store.createIndex('grind_size', 'grind_size', { unique: false });
                            store.createIndex('water_amount', 'water_amount', { unique: false });
                        }
                    };
                });
            }

            async addBrew(brew) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);

                    brew.created_at = brew.created_at || new Date().toISOString();
                    const request = store.add(brew);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async updateBrew(id, brew) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);

                    brew.id = id;
                    const request = store.put(brew);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async deleteBrew(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.delete(id);

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async getBrew(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(id);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAllBrews(sortBy = 'created_at', ascending = false) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAll();

                    request.onsuccess = () => {
                        let results = request.result;
                        results.sort((a, b) => {
                            let valA = a[sortBy];
                            let valB = b[sortBy];

                            if (typeof valA === 'string') {
                                valA = valA.toLowerCase();
                                valB = valB.toLowerCase();
                            }

                            if (ascending) {
                                return valA < valB ? -1 : valA > valB ? 1 : 0;
                            } else {
                                return valA > valB ? -1 : valA < valB ? 1 : 0;
                            }
                        });
                        resolve(results);
                    };
                    request.onerror = () => reject(request.error);
                });
            }

            async getBrewsInRange(startDate, endDate) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const index = store.index('created_at');
                    const range = IDBKeyRange.bound(startDate.toISOString(), endDate.toISOString());
                    const request = index.getAll(range);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getUniqueCoffeeNames() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAll();

                    request.onsuccess = () => {
                        const names = [...new Set(request.result.map(item => item.coffee_name))];
                        resolve(names.filter(n => n));
                    };
                    request.onerror = () => reject(request.error);
                });
            }

            async exportAll() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async importBrews(brews, replace = false) {
                return new Promise(async (resolve, reject) => {
                    try {
                        if (replace) {
                            const transaction = this.db.transaction([this.storeName], 'readwrite');
                            const store = transaction.objectStore(this.storeName);
                            await new Promise((res, rej) => {
                                const clearReq = store.clear();
                                clearReq.onsuccess = () => res();
                                clearReq.onerror = () => rej(clearReq.error);
                            });
                        }

                        for (const brew of brews) {
                            const brewCopy = { ...brew };
                            delete brewCopy.id; // Let auto-increment handle IDs
                            await this.addBrew(brewCopy);
                        }
                        resolve(brews.length);
                    } catch (error) {
                        reject(error);
                    }
                });
            }
        }

        // ============================================
        // Global State
        // ============================================
        const brewDB = new BrewDB();
        let mainChart = null;
        let currentVariable = 'coffee_name';
        let currentView = 'logger';
        let allBrews = [];

        // ============================================
        // View Switching
        // ============================================
        function switchView(view) {
            currentView = view;

            // Update views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(view + 'View').classList.add('active');

            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.nav-tab[onclick="switchView('${view}')"]`).classList.add('active');

            // Update header
            if (view === 'logger') {
                document.getElementById('headerTitle').textContent = 'BrewTracker';
                document.getElementById('headerSubtitle').textContent = 'Dokumentiere deine perfekte Tasse Kaffee';
            } else {
                document.getElementById('headerTitle').textContent = 'Dashboard';
                document.getElementById('headerSubtitle').textContent = 'Alles was ich wissen muss.';
                loadDashboardData();
            }
        }

        // ============================================
        // Logger Functions
        // ============================================
        function toggleForm() {
            const form = document.getElementById('formContainer');
            form.classList.toggle('active');
        }

        function addBrewSequence() {
            const container = document.getElementById('brewSequences');
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'brew-sequence';
            div.innerHTML = `
                <div class="brew-sequence-header">
                    <strong>Sequenz ${index + 1}</strong>
                    <button type="button" class="btn btn-danger btn-small" onclick="removeBrewSequence(this)">Entfernen</button>
                </div>
                <div class="brew-sequence-inputs">
                    <div>
                        <label>Wassermenge (g):</label>
                        <input type="number" class="seq-water" step="0.1" required>
                    </div>
                    <div>
                        <label>Wartezeit (s):</label>
                        <input type="number" class="seq-wait" required>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function removeBrewSequence(btn) {
            btn.closest('.brew-sequence').remove();
            updateSequenceNumbers();
        }

        function updateSequenceNumbers() {
            const sequences = document.querySelectorAll('.brew-sequence');
            sequences.forEach((seq, index) => {
                seq.querySelector('strong').textContent = `Sequenz ${index + 1}`;
            });
        }

        async function saveBrew(event) {
            event.preventDefault();

            const sequences = [];
            document.querySelectorAll('.brew-sequence').forEach(seq => {
                sequences.push({
                    water: parseFloat(seq.querySelector('.seq-water').value),
                    wait: parseInt(seq.querySelector('.seq-wait').value)
                });
            });

            const tasteRadio = document.querySelector('input[name="taste"]:checked');
            if (!tasteRadio) {
                alert('Bitte wähle eine Geschmacksbewertung aus.');
                return;
            }

            const data = {
                coffee_name: document.getElementById('coffeeName').value,
                grind_size: parseFloat(document.getElementById('grindSize').value),
                coffee_amount: parseFloat(document.getElementById('coffeeAmount').value),
                water_amount: parseInt(document.getElementById('waterAmount').value),
                water_temp: parseInt(document.getElementById('waterTemp').value),
                brew_sequences: sequences,
                brew_time: document.getElementById('brewTime').value,
                is_french_press: document.getElementById('frenchPress').checked,
                taste: parseInt(tasteRadio.value),
                notes: document.getElementById('notes').value
            };

            const editId = document.getElementById('editId').value;

            try {
                if (editId) {
                    const existingBrew = await brewDB.getBrew(parseInt(editId));
                    data.created_at = existingBrew.created_at;
                    await brewDB.updateBrew(parseInt(editId), data);
                } else {
                    await brewDB.addBrew(data);
                }

                document.getElementById('brewForm').reset();
                document.getElementById('editId').value = '';
                document.getElementById('brewSequences').innerHTML = '';
                toggleForm();
                loadEntries();
                loadCoffeeNames();
            } catch (error) {
                alert('Fehler beim Speichern: ' + error.message);
            }
        }

        async function loadEntries() {
            const sortBy = document.getElementById('sortBy').value;
            const ascending = sortBy !== 'created_at' && sortBy !== 'taste';

            try {
                const data = await brewDB.getAllBrews(sortBy, ascending);
                displayEntries(data);
            } catch (error) {
                console.error('Fehler beim Laden:', error);
            }
        }

        function displayEntries(entries) {
            const container = document.getElementById('entriesList');
            container.innerHTML = '';

            if (entries.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6B4423; padding: 30px;">Noch keine Einträge vorhanden.</p>';
                return;
            }

            entries.forEach(entry => {
                const card = document.createElement('div');
                card.className = 'entry-card';
                const stars = '★'.repeat(entry.taste) + '☆'.repeat(5 - entry.taste);
                const date = new Date(entry.created_at).toLocaleDateString('de-DE');

                const sequencesHTML = (entry.brew_sequences || []).map((seq, index) => `
                    <div class="sequence-item">
                        <span class="sequence-number">${index + 1}.</span>
                        <span class="sequence-detail">${seq.water}g Wasser</span>
                        <span class="sequence-detail">${seq.wait}s warten</span>
                    </div>
                `).join('');

                card.innerHTML = `
                    <div class="entry-header" onclick="toggleEntry(this)">
                        <div>
                            <div class="entry-title">${entry.coffee_name}</div>
                            <div class="entry-date">${date}</div>
                        </div>
                        <div class="stars">${stars}</div>
                        <div class="stars">${entry.water_amount}ml</div>
                    </div>
                    <div class="entry-content">
                        <div class="entry-details">
                            <div class="entry-detail"><strong>Mahlgrad:</strong> ${entry.grind_size}</div>
                            <div class="entry-detail"><strong>Kaffee:</strong> ${entry.coffee_amount}g</div>
                            <div class="entry-detail"><strong>Wasser:</strong> ${entry.water_amount}ml</div>
                            <div class="entry-detail"><strong>Temperatur:</strong> ${entry.water_temp}°C</div>
                            <div class="entry-detail"><strong>Zeit:</strong> ${entry.brew_time}</div>
                            <div class="entry-detail"><strong>Methode:</strong> ${entry.is_french_press ? 'French Press' : 'Pour Over'}</div>
                        </div>
                        ${sequencesHTML ? `
                        <div class="brew-sequences-display">
                            <strong>Brühsequenzen:</strong>
                            <div class="sequences-list">${sequencesHTML}</div>
                        </div>
                        ` : ''}
                        ${entry.notes ? `<p><strong>Notizen:</strong> ${entry.notes}</p>` : ''}
                        <div class="entry-actions">
                            <button class="btn btn-primary btn-small" onclick="event.stopPropagation(); editEntry(${entry.id})">Bearbeiten</button>
                            <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); deleteEntry(${entry.id})">Löschen</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function loadCoffeeNames() {
            try {
                const names = await brewDB.getUniqueCoffeeNames();
                const datalist = document.getElementById('coffeeNamesList');
                datalist.innerHTML = names.map(name => `<option value="${name}">`).join('');
            } catch (error) {
                console.error('Fehler beim Laden der Kaffeenamen:', error);
            }
        }

        async function editEntry(id) {
            try {
                const data = await brewDB.getBrew(id);

                document.getElementById('editId').value = data.id;
                document.getElementById('coffeeName').value = data.coffee_name;
                document.getElementById('grindSize').value = data.grind_size;
                document.getElementById('coffeeAmount').value = data.coffee_amount;
                document.getElementById('waterAmount').value = data.water_amount;
                document.getElementById('waterTemp').value = data.water_temp;
                document.getElementById('brewTime').value = data.brew_time;
                document.getElementById('frenchPress').checked = data.is_french_press || false;
                document.getElementById(`taste${data.taste}`).checked = true;
                document.getElementById('notes').value = data.notes || '';

                document.getElementById('brewSequences').innerHTML = '';
                (data.brew_sequences || []).forEach(seq => {
                    addBrewSequence();
                    const lastSeq = document.querySelector('.brew-sequence:last-child');
                    lastSeq.querySelector('.seq-water').value = seq.water;
                    lastSeq.querySelector('.seq-wait').value = seq.wait;
                });

                document.getElementById('formContainer').classList.add('active');
                document.getElementById('formContainer').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                alert('Fehler beim Laden des Eintrags: ' + error.message);
            }
        }

        async function deleteEntry(id) {
            if (!confirm('Möchtest du diesen Eintrag wirklich löschen?')) return;
            try {
                await brewDB.deleteBrew(id);
                loadEntries();
            } catch (error) {
                alert('Fehler beim Löschen: ' + error.message);
            }
        }

        function toggleEntry(header) {
            const content = header.nextElementSibling;
            content.classList.toggle('expanded');
        }

        function cancelEdit() {
            document.getElementById('brewForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('brewSequences').innerHTML = '';
            toggleForm();
        }

        // ============================================
        // Export/Import Functions
        // ============================================
        async function exportData() {
            try {
                const data = await brewDB.exportAll();
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const date = new Date().toISOString().split('T')[0];
                const a = document.createElement('a');
                a.href = url;
                a.download = `brewtracker-backup-${date}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('Fehler beim Export: ' + error.message);
            }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                if (!Array.isArray(data)) {
                    throw new Error('Ungültiges Datenformat. Erwartet: Array von Braueinträgen.');
                }

                // Validate data structure
                const requiredFields = ['coffee_name', 'grind_size', 'coffee_amount', 'water_amount', 'water_temp', 'brew_time', 'taste'];
                for (const brew of data) {
                    for (const field of requiredFields) {
                        if (brew[field] === undefined) {
                            throw new Error(`Fehlende Pflichtfeld: ${field}`);
                        }
                    }
                }

                const replace = confirm('Möchtest du alle bestehenden Daten ersetzen?\n\nOK = Ersetzen\nAbbrechen = Hinzufügen');
                const count = await brewDB.importBrews(data, replace);
                alert(`${count} Einträge erfolgreich importiert!`);
                loadEntries();
                loadCoffeeNames();
            } catch (error) {
                alert('Fehler beim Import: ' + error.message);
            }

            event.target.value = '';
        }

        // ============================================
        // Dashboard Functions
        // ============================================
        const variableLabels = {
            coffee_name: 'Kaffee Name',
            taste: 'Geschmack',
            grind_size: 'Mahlgrad',
            water_amount: 'Wassermenge',
            coffee_amount: 'Kaffeemenge',
            water_temp: 'Temperatur',
            is_french_press: 'French Press'
        };

        function selectVariable(variable) {
            currentVariable = variable;

            // Update button states
            document.querySelectorAll('.variable-selector .btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.variable === variable);
            });

            loadVariableData();
        }

        async function loadDashboardData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('chartView').style.display = 'none';
            document.getElementById('drillDownView').style.display = 'none';
            document.getElementById('dashboardError').style.display = 'none';

            try {
                allBrews = await brewDB.getAllBrews('created_at', false);

                if (!allBrews || allBrews.length === 0) {
                    document.getElementById('dashboardError').textContent = 'Keine Daten vorhanden.';
                    document.getElementById('dashboardError').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                    return;
                }

                loadVariableData();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('chartView').style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('dashboardError').textContent = 'Fehler beim Laden der Daten: ' + error.message;
                document.getElementById('dashboardError').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }

        function loadVariableData() {
            const aggregated = {};

            if (currentVariable === 'is_french_press') {
                // For French Press, show coffee names where FP=true
                allBrews.forEach(brew => {
                    if (brew.is_french_press) {
                        const key = brew.coffee_name || 'Unbekannt';
                        aggregated[key] = (aggregated[key] || 0) + 1;
                    }
                });
            } else {
                allBrews.forEach(brew => {
                    let key = brew[currentVariable];
                    if (currentVariable === 'taste') {
                        key = key + ' ★';
                    } else if (key === undefined || key === null) {
                        key = 'Unbekannt';
                    }
                    aggregated[key] = (aggregated[key] || 0) + 1;
                });
            }

            // Sort by count descending
            const sorted = Object.entries(aggregated).sort((a, b) => b[1] - a[1]);
            const labels = sorted.map(item => String(item[0]));
            const counts = sorted.map(item => item[1]);

            // Update chart title
            const titleEl = document.getElementById('chartTitle');
            if (currentVariable === 'is_french_press') {
                titleEl.textContent = 'French Press Einträge pro Kaffee';
            } else {
                titleEl.textContent = `Einträge pro ${variableLabels[currentVariable]}`;
            }

            updateMainChart(labels, counts);
        }

        function updateMainChart(labels, data) {
            if (mainChart) mainChart.destroy();

            // Calculate dynamic height based on number of bars
            const barHeight = 30;
            const minHeight = 250;
            const maxHeight = 500;
            const calculatedHeight = Math.min(maxHeight, Math.max(minHeight, labels.length * barHeight));
            const canvas = document.getElementById('mainChart');
            canvas.style.height = calculatedHeight + 'px';

            const ctx = canvas.getContext('2d');
            mainChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Anzahl Einträge',
                        data: data,
                        backgroundColor: 'rgba(139, 90, 60, 0.8)',
                        borderColor: 'rgba(139, 90, 60, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    onClick: (event, elements, chart) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const clickedLabel = chart.data.labels[index];
                            showDrillDown(clickedLabel, index);
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.parsed.x} Einträge`
                            }
                        },
                        legend: {
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        y: {
                            ticks: {
                                font: {
                                    size: 13
                                }
                            }
                        }
                    }
                }
            });
        }

        function showDrillDown(value, index) {
            // Filter entries based on variable type
            let entries;
            if (currentVariable === 'is_french_press') {
                entries = allBrews.filter(b => b.is_french_press && b.coffee_name === value);
            } else if (currentVariable === 'taste') {
                const filterValue = parseInt(value.replace(' ★', ''));
                entries = allBrews.filter(b => b.taste === filterValue);
            } else if (['grind_size', 'water_amount', 'coffee_amount', 'water_temp'].includes(currentVariable)) {
                // Use loose equality to handle number/string type differences
                const numValue = parseFloat(value);
                entries = allBrews.filter(b => b[currentVariable] == numValue);
            } else {
                entries = allBrews.filter(b => b[currentVariable] === value);
            }

            // Sort entries based on variable type
            if (currentVariable === 'coffee_name' || currentVariable === 'is_french_press') {
                entries.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            } else {
                entries.sort((a, b) => (a.coffee_name || '').localeCompare(b.coffee_name || ''));
            }

            // Update title
            document.getElementById('drillDownTitle').textContent =
                currentVariable === 'is_french_press'
                    ? `French Press: ${value}`
                    : `${variableLabels[currentVariable]}: ${value}`;

            // Calculate and display stats
            const stats = calculateStats(entries);
            displayStats(stats);

            // Show common factors for taste drill-down
            const commonFactorsEl = document.getElementById('commonFactors');
            if (currentVariable === 'taste') {
                const factors = calculateCommonFactors(entries);
                displayCommonFactors(factors);
                commonFactorsEl.style.display = 'block';
            } else {
                commonFactorsEl.style.display = 'none';
            }

            // Update entries heading
            const entriesHeading = document.getElementById('entriesHeading');
            if (currentVariable === 'coffee_name' || currentVariable === 'is_french_press') {
                entriesHeading.textContent = `Einträge (${entries.length}) - sortiert nach Datum`;
            } else {
                entriesHeading.textContent = `Einträge (${entries.length}) - sortiert nach Kaffee Name`;
            }

            // Display entries
            renderDrillDownEntries(entries);

            // Switch views
            document.getElementById('chartView').style.display = 'none';
            document.getElementById('variableSelector').style.display = 'none';
            document.getElementById('drillDownView').style.display = 'block';
        }

        function showChartView() {
            document.getElementById('drillDownView').style.display = 'none';
            document.getElementById('variableSelector').style.display = 'flex';
            document.getElementById('chartView').style.display = 'block';
        }

        function calculateStats(entries) {
            if (entries.length === 0) {
                return null;
            }

            const sum = (arr) => arr.reduce((a, b) => a + b, 0);
            const avg = (arr) => arr.length > 0 ? sum(arr) / arr.length : 0;

            const tastes = entries.map(e => e.taste).filter(t => t != null);
            const grindSizes = entries.map(e => e.grind_size).filter(g => g != null);
            const waterAmounts = entries.map(e => e.water_amount).filter(w => w != null);
            const coffeeAmounts = entries.map(e => e.coffee_amount).filter(c => c != null);
            const waterTemps = entries.map(e => e.water_temp).filter(t => t != null);
            const dates = entries.map(e => new Date(e.created_at)).sort((a, b) => a - b);

            return {
                totalEntries: entries.length,
                avgTaste: avg(tastes),
                avgGrindSize: avg(grindSizes),
                avgWaterAmount: avg(waterAmounts),
                avgCoffeeAmount: avg(coffeeAmounts),
                avgWaterTemp: avg(waterTemps),
                firstDate: dates[0],
                lastDate: dates[dates.length - 1]
            };
        }

        function displayStats(stats) {
            const container = document.getElementById('statsGrid');
            if (!stats) {
                container.innerHTML = '<p>Keine Statistiken verfügbar.</p>';
                return;
            }

            const formatDate = (date) => {
                if (!date) return '-';
                return date.toLocaleDateString('de-DE');
            };

            const starsHtml = (rating) => {
                const fullStars = Math.round(rating);
                return '★'.repeat(fullStars) + '☆'.repeat(5 - fullStars);
            };

            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Einträge</div>
                    <div class="stat-value">${stats.totalEntries}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ø Geschmack</div>
                    <div class="stat-value"><span class="stars">${starsHtml(stats.avgTaste)}</span> (${stats.avgTaste.toFixed(1)})</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ø Mahlgrad</div>
                    <div class="stat-value">${stats.avgGrindSize.toFixed(1)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ø Wassermenge</div>
                    <div class="stat-value">${Math.round(stats.avgWaterAmount)} ml</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ø Kaffeemenge</div>
                    <div class="stat-value">${stats.avgCoffeeAmount.toFixed(1)} g</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ø Temperatur</div>
                    <div class="stat-value">${Math.round(stats.avgWaterTemp)} °C</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Erster Eintrag</div>
                    <div class="stat-value">${formatDate(stats.firstDate)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Letzter Eintrag</div>
                    <div class="stat-value">${formatDate(stats.lastDate)}</div>
                </div>
            `;
        }

        function calculateCommonFactors(entries) {
            // Count coffee names
            const coffeeCounts = {};
            entries.forEach(e => {
                const name = e.coffee_name || 'Unbekannt';
                coffeeCounts[name] = (coffeeCounts[name] || 0) + 1;
            });

            // Sort by count and take top 3
            const topCoffees = Object.entries(coffeeCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([name, count]) => `${name} (${count}×)`);

            // Calculate averages
            const avgGrind = entries.reduce((sum, e) => sum + (e.grind_size || 0), 0) / entries.length;
            const avgWater = entries.reduce((sum, e) => sum + (e.water_amount || 0), 0) / entries.length;
            const avgTemp = entries.reduce((sum, e) => sum + (e.water_temp || 0), 0) / entries.length;

            return {
                topCoffees,
                avgGrind: avgGrind.toFixed(1),
                avgWater: Math.round(avgWater),
                avgTemp: Math.round(avgTemp)
            };
        }

        function displayCommonFactors(factors) {
            const container = document.getElementById('commonFactors');
            container.innerHTML = `
                <h4>Häufige Faktoren bei dieser Bewertung</h4>
                <ul>
                    <li><strong>Top Kaffeesorten:</strong> ${factors.topCoffees.join(', ') || 'Keine'}</li>
                    <li><strong>Ø Mahlgrad:</strong> ${factors.avgGrind}</li>
                    <li><strong>Ø Wassermenge:</strong> ${factors.avgWater} ml</li>
                    <li><strong>Ø Temperatur:</strong> ${factors.avgTemp} °C</li>
                </ul>
            `;
        }

        function renderDrillDownEntries(entries) {
            const container = document.getElementById('drillDownEntries');
            container.innerHTML = '';

            if (entries.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6B4423; padding: 30px;">Keine Einträge gefunden.</p>';
                return;
            }

            entries.forEach(entry => {
                const card = document.createElement('div');
                card.className = 'entry-card';
                const stars = '★'.repeat(entry.taste) + '☆'.repeat(5 - entry.taste);
                const date = new Date(entry.created_at).toLocaleDateString('de-DE');

                const sequencesHTML = (entry.brew_sequences || []).map((seq, index) => `
                    <div class="sequence-item">
                        <span class="sequence-number">${index + 1}.</span>
                        <span class="sequence-detail">${seq.water}g Wasser</span>
                        <span class="sequence-detail">${seq.wait}s warten</span>
                    </div>
                `).join('');

                card.innerHTML = `
                    <div class="entry-header" onclick="toggleEntry(this)">
                        <div>
                            <div class="entry-title">${entry.coffee_name}</div>
                            <div class="entry-date">${date}</div>
                        </div>
                        <div class="stars">${stars}</div>
                        <div class="stars">${entry.water_amount}ml</div>
                    </div>
                    <div class="entry-content">
                        <div class="entry-details">
                            <div class="entry-detail"><strong>Mahlgrad:</strong> ${entry.grind_size}</div>
                            <div class="entry-detail"><strong>Kaffee:</strong> ${entry.coffee_amount}g</div>
                            <div class="entry-detail"><strong>Wasser:</strong> ${entry.water_amount}ml</div>
                            <div class="entry-detail"><strong>Temperatur:</strong> ${entry.water_temp}°C</div>
                            <div class="entry-detail"><strong>Zeit:</strong> ${entry.brew_time}</div>
                            <div class="entry-detail"><strong>Methode:</strong> ${entry.is_french_press ? 'French Press' : 'Pour Over'}</div>
                        </div>
                        ${sequencesHTML ? `
                        <div class="brew-sequences-display">
                            <strong>Brühsequenzen:</strong>
                            <div class="sequences-list">${sequencesHTML}</div>
                        </div>
                        ` : ''}
                        ${entry.notes ? `<p><strong>Notizen:</strong> ${entry.notes}</p>` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // ============================================
        // Service Worker Registration
        // ============================================
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(registration => {
                    console.log('Service Worker registered:', registration.scope);
                })
                .catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
        }

        // ============================================
        // Initialization
        // ============================================
        window.onload = async function() {
            try {
                await brewDB.init();
                loadEntries();
                loadCoffeeNames();
                addBrewSequence();
            } catch (error) {
                console.error('Fehler beim Initialisieren der Datenbank:', error);
                alert('Fehler beim Initialisieren der App. Bitte Browser-Unterstützung für IndexedDB prüfen.');
            }
        };
    </script>
</body>
</html>
